---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HallwayBackdrop from '../components/HallwayBackdrop.astro';
import GarlandFrame from '../components/GarlandFrame.astro';

interface Props {
  title: string;
  description?: string;
  image?: string;
  theme?: string;
}

const {
  title,
  description = 'Timeline and archive for A Path Toward Life',
  image = 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&w=1200&q=80',
  theme = 'archive'
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <title>{title}</title>
  </head>
  <body data-theme={theme}>
    <div id="cursor-aura" aria-hidden="true"></div>
    <HallwayBackdrop accent="var(--accent-2)" />
    <div class="site-overlay" aria-hidden="true"></div>
    <GarlandFrame />
    <Header />
    <main class="page-shell w-full">
      <div class="site-content">
        <slot />
      </div>
    </main>
    <Footer />
    <script is:inline>
      (() => {
        const root = document.documentElement;
        const light = document.getElementById('cursorLight');

        const isha = {
          yellow: '#F5D547',
          blue: '#45C7FF',
          orange: '#FF8A2A',
          red: '#FF3B3B',
          white: '#EDEDED',
          black: '#0B0B0E'
        };

        function hexToRgb(hex) {
          const h = String(hex).replace('#', '');
          const n = parseInt(h.length === 3 ? h.split('').map((c) => c + c).join('') : h, 16);
          return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
        }

        function rgbToHex(rgb) {
          const to = (v) => Math.max(0, Math.min(255, Number(v) || 0)).toString(16).padStart(2, '0');
          return `#${to(rgb.r)}${to(rgb.g)}${to(rgb.b)}`;
        }

        function complement(hex) {
          const c = hexToRgb(hex);
          return rgbToHex({ r: 255 - c.r, g: 255 - c.g, b: 255 - c.b });
        }

        function setAccentFromActiveLink() {
          const active =
            document.querySelector("nav a[aria-current='page']") || document.querySelector('nav a[data-color]');
          if (!active) return;

          const key = active.getAttribute('data-color');
          const base = isha[key] || isha.blue;

          root.style.setProperty('--accent', base);
          root.style.setProperty('--cursor', complement(base));
          root.style.setProperty('--tone-accent', base);
          root.style.setProperty('--tone-accent-bright', `color-mix(in srgb, ${base} 82%, #fff 18%)`);
          root.style.setProperty('--tone-accent-glow', `color-mix(in srgb, ${base} 72%, #fff 28%)`);
        }

        setAccentFromActiveLink();
        const hasFinePointer = window.matchMedia('(pointer: fine)').matches;
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const CURSOR_IDLE_MS = 12000;
        let idleTimer = null;

        const setCursorIdle = (isIdle) => {
          root.dataset.cursorIdle = isIdle ? 'true' : 'false';
        };

        const resetCursorIdleTimer = () => {
          if (!hasFinePointer || prefersReducedMotion) return;
          setCursorIdle(false);
          if (idleTimer) window.clearTimeout(idleTimer);
          idleTimer = window.setTimeout(() => {
            setCursorIdle(true);
          }, CURSOR_IDLE_MS);
        };

        if (!hasFinePointer || prefersReducedMotion) {
          setCursorIdle(true);
        } else {
          resetCursorIdleTimer();
          document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
              setCursorIdle(true);
            } else {
              resetCursorIdleTimer();
            }
          });
        }

        window.addEventListener(
          'pointermove',
          (e) => {
            const px = `${e.clientX}px`;
            const py = `${e.clientY}px`;
            root.style.setProperty('--mx', px);
            root.style.setProperty('--my', py);
            root.style.setProperty('--aura-x', px);
            root.style.setProperty('--aura-y', py);
            root.style.setProperty('--hallway-x', px);
            root.style.setProperty('--hallway-y', py);
            if (light) {
              light.style.left = px;
              light.style.top = py;
            }
            resetCursorIdleTimer();
          },
          { passive: true }
        );
      })();
    </script>
  </body>
</html>
