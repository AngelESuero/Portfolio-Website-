---
interface InstagramPreviewItem {
  src: string;
  caption?: string;
  date?: string;
}

interface XFeedItem {
  title: string;
  url: string;
  publishedAt?: string;
  summary?: string;
}

interface HomeSocialFeedsProps {
  xHandle: string;
  xFeedItems: XFeedItem[];
  youtubeUploadsEmbedUrl: string;
  youtubeChannelUrl: string;
  instagramProfileUrl: string;
  instagramArchiveUrl: string;
  instagramPreview: InstagramPreviewItem[];
}

const {
  xHandle,
  xFeedItems,
  youtubeUploadsEmbedUrl,
  youtubeChannelUrl,
  instagramProfileUrl,
  instagramArchiveUrl,
  instagramPreview
} = Astro.props as HomeSocialFeedsProps;

const normalizedXHandle = String(xHandle || '').trim().replace(/^@/, '');
const xTimelineUrl = normalizedXHandle ? `https://twitter.com/${normalizedXHandle}` : 'https://twitter.com';
const formatXDate = (value?: string): string => {
  if (!value) return '';
  const date = new Date(value);
  if (Number.isNaN(date.valueOf())) return '';
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  }).format(date);
};
const normalizedXItems = (Array.isArray(xFeedItems) ? xFeedItems : [])
  .map((item) => ({
    title: String(item?.title || '').trim(),
    url: String(item?.url || '').trim(),
    publishedAt: String(item?.publishedAt || '').trim(),
    summary: String(item?.summary || '').trim()
  }))
  .filter((item) => item.title && item.url)
  .sort((a, b) => {
    const aTime = new Date(a.publishedAt || 0).valueOf();
    const bTime = new Date(b.publishedAt || 0).valueOf();
    return bTime - aTime;
  })
  .slice(0, 6);
const hasXItems = normalizedXItems.length > 0;
const previewItems = (Array.isArray(instagramPreview) ? instagramPreview : [])
  .filter((item) => typeof item?.src === 'string' && item.src)
  .slice(0, 4);
const hasPreview = previewItems.length > 0;
const xWidgetRootId = 'home-social-x-widget';
const youtubeFrameId = 'home-social-youtube-frame';
const youtubeStatusId = 'home-social-youtube-status';
---

<section class="home-social-feeds" aria-label="Social feeds">
  <header class="home-social-feeds-header">
    <p class="home-social-feeds-kicker">Social feeds</p>
    <h2 class="font-display text-2xl">Social Feeds</h2>
    <p class="home-social-feeds-dek">Live updates from X, YouTube uploads, and local Instagram archive previews.</p>
  </header>

  <div class="home-social-feeds-grid">
    <article class="home-social-card" data-provider="x">
      <p class="home-social-card-kicker">Latest posts</p>
      <h3>X</h3>
      <p class="home-social-card-dek">Latest short-form notes and commentary from @{normalizedXHandle}.</p>
      <div id={xWidgetRootId} class="home-social-frame home-social-frame-x">
        <a
          class="twitter-timeline"
          href={xTimelineUrl}
          data-dnt="true"
          data-chrome="noheader nofooter transparent"
          data-tweet-limit="6"
        >
          Posts by @{normalizedXHandle}
        </a>
        <div class="home-social-x-fallback" aria-live="polite">
          {hasXItems ? (
            <ul class="home-social-x-list">
              {normalizedXItems.map((item) => (
                <li>
                  <a href={item.url} target="_blank" rel="noopener">{item.title}</a>
                  {item.publishedAt && <p class="home-social-x-meta">{formatXDate(item.publishedAt)}</p>}
                  {item.summary && <p class="home-social-x-summary">{item.summary}</p>}
                </li>
              ))}
            </ul>
          ) : (
            <p>Timeline preview is unavailable right now. Use the links below.</p>
          )}
        </div>
      </div>
      <p class="home-social-links">
        <a href="/social/x">Open full feed</a>
        <a href={xTimelineUrl} target="_blank" rel="noopener">Open profile</a>
      </p>
    </article>

    <article class="home-social-card" data-provider="youtube">
      <p class="home-social-card-kicker">Uploads</p>
      <h3>YouTube</h3>
      <p class="home-social-card-dek">Latest uploads playlist from your channel.</p>
      <div id={youtubeFrameId} class="home-social-frame home-social-frame-youtube">
        <iframe
          src={youtubeUploadsEmbedUrl}
          title="YouTube uploads"
          loading="lazy"
          data-fallback-src={youtubeUploadsEmbedUrl}
          allow="autoplay; fullscreen; encrypted-media; picture-in-picture"
          allowfullscreen
        ></iframe>
      </div>
      <p id={youtubeStatusId} class="home-social-youtube-status" aria-live="polite">Checking latest feedâ€¦</p>
      <p class="home-social-links">
        <a href="/social/youtube">Open full feed</a>
        <a href={youtubeChannelUrl} target="_blank" rel="noopener">Open channel</a>
      </p>
    </article>

    <article class="home-social-card" data-provider="instagram">
      <p class="home-social-card-kicker">Local archive</p>
      <h3>Instagram</h3>
      <p class="home-social-card-dek">Local-first archive preview linked to your Instagram hub.</p>
      {hasPreview ? (
        <div class="home-social-ig-grid">
          {previewItems.map((item) => (
            <a href={instagramArchiveUrl} class="home-social-ig-tile">
              <img src={item.src} alt={item.caption || item.date || 'Instagram archive preview'} loading="lazy" decoding="async" />
            </a>
          ))}
        </div>
      ) : (
        <div class="home-social-ig-fallback">
          <p>Archive previews will appear here once local Instagram media is available.</p>
        </div>
      )}
      <p class="home-social-links">
        <a href="/social/instagram">Open social page</a>
        <a href={instagramProfileUrl} target="_blank" rel="noopener">Open profile</a>
      </p>
    </article>
  </div>
</section>

<script is:inline define:vars={{ xWidgetRootId }}>
  (() => {
    const root = document.getElementById(xWidgetRootId);
    if (!root) return;

    const showFallback = () => {
      if (root.querySelector('iframe')) {
        root.classList.remove('is-fallback');
        return;
      }
      root.classList.add('is-fallback');
    };

    const scheduleFallbackCheck = () => {
      window.setTimeout(showFallback, 4500);
    };

    const observer = new MutationObserver(() => {
      if (root.querySelector('iframe')) {
        root.classList.remove('is-fallback');
      }
    });
    observer.observe(root, { childList: true, subtree: true });

    const timelineLink = root.querySelector('a.twitter-timeline');
    if (timelineLink) {
      const prefersDark = document.documentElement.classList.contains('dark');
      timelineLink.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    }

    const twttr = window.twttr;
    if (twttr?.widgets?.load) {
      twttr.widgets.load(root);
      scheduleFallbackCheck();
      return;
    }

    const scriptId = 'home-social-x-widgets-script';
    if (document.getElementById(scriptId)) {
      scheduleFallbackCheck();
      return;
    }

    const script = document.createElement('script');
    script.id = scriptId;
    script.async = true;
    script.src = 'https://platform.twitter.com/widgets.js';
    script.charset = 'utf-8';
    script.addEventListener('load', () => {
      const loadedTwttr = window.twttr;
      if (loadedTwttr?.widgets?.load) loadedTwttr.widgets.load(root);
      scheduleFallbackCheck();
    });
    script.addEventListener('error', showFallback);
    document.head.appendChild(script);
    scheduleFallbackCheck();
  })();
</script>

<script is:inline define:vars={{ youtubeFrameId, youtubeStatusId }}>
  (() => {
    const frame = document.getElementById(youtubeFrameId);
    const status = document.getElementById(youtubeStatusId);
    const iframe = frame?.querySelector('iframe');
    if (!frame || !status || !iframe) return;

    const fallbackSrc = iframe.getAttribute('data-fallback-src') || iframe.getAttribute('src') || '';

    const setStatus = (message) => {
      status.textContent = message;
    };

    const toEmbedUrl = (videoId) => `https://www.youtube.com/embed/${encodeURIComponent(videoId)}?rel=0`;

    const formatDate = (value) => {
      const date = new Date(value);
      if (Number.isNaN(date.valueOf())) return '';
      return new Intl.DateTimeFormat('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      }).format(date);
    };

    const cleanVideoId = (value) => String(value || '').trim().replace(/[^A-Za-z0-9_-]/g, '');

    const parseVideoId = (value) => {
      const raw = String(value || '').trim();
      if (!raw) return '';

      try {
        const parsed = new URL(raw);
        const host = parsed.hostname.replace(/^www\./, '').toLowerCase();

        if (host === 'youtu.be') {
          const direct = cleanVideoId(parsed.pathname.split('/').filter(Boolean)[0] || '');
          if (direct) return direct;
        }

        if (host.endsWith('youtube.com') || host.endsWith('youtube-nocookie.com')) {
          if (parsed.pathname === '/watch') {
            const watchId = cleanVideoId(parsed.searchParams.get('v') || '');
            if (watchId) return watchId;
          }

          const segments = parsed.pathname.split('/').filter(Boolean);
          if (segments.length >= 2 && ['shorts', 'embed', 'live'].includes(segments[0])) {
            const segmentId = cleanVideoId(segments[1] || '');
            if (segmentId) return segmentId;
          }
        }
      } catch {}

      const regexes = [
        /[?&]v=([A-Za-z0-9_-]{6,})/i,
        /youtu\.be\/([A-Za-z0-9_-]{6,})/i,
        /\/shorts\/([A-Za-z0-9_-]{6,})/i,
        /\/embed\/([A-Za-z0-9_-]{6,})/i
      ];

      for (const regex of regexes) {
        const match = raw.match(regex);
        if (match?.[1]) return cleanVideoId(match[1]);
      }

      return '';
    };

    fetch('/api/social-rss?slug=youtube')
      .then((response) => {
        if (!response.ok) throw new Error(`RSS endpoint returned ${response.status}`);
        return response.json();
      })
      .then((payload) => {
        const items = Array.isArray(payload?.items) ? payload.items : [];
        const latest = items.find((item) => parseVideoId(item?.url || ''));
        if (!latest) {
          setStatus('Using latest available embed.');
          return;
        }

        const latestVideoId = parseVideoId(latest.url || '');
        if (!latestVideoId) {
          setStatus('Using latest available embed.');
          return;
        }

        iframe.src = toEmbedUrl(latestVideoId);
        const formattedDate = formatDate(latest.date || '');
        setStatus(formattedDate ? `Updated ${formattedDate}.` : 'Updated recently.');
      })
      .catch(() => {
        if (fallbackSrc) iframe.src = fallbackSrc;
        setStatus('Using latest available embed.');
      });
  })();
</script>

<style>
  .home-social-feeds {
    margin-top: 2.25rem;
  }

  .home-social-feeds-header {
    margin: 0 0 1.05rem;
  }

  .home-social-feeds-kicker {
    margin: 0 0 0.4rem;
    font-size: 0.72rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--tone-muted);
  }

  .home-social-feeds-header h2 {
    margin: 0;
  }

  .home-social-feeds-dek {
    margin: 0.5rem 0 0;
    color: var(--tone-muted);
    max-width: 66ch;
    line-height: 1.58;
  }

  .home-social-feeds-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.95rem;
    align-items: stretch;
  }

  .home-social-card {
    --social-accent: color-mix(in srgb, var(--tone-accent) 42%, #ffffff 58%);
    border: 1px solid var(--line2);
    border-radius: 0.92rem;
    background:
      linear-gradient(180deg, color-mix(in srgb, var(--social-accent) 5%, transparent) 0%, transparent 40%),
      var(--tone-surface-strong);
    padding: 0.88rem;
    display: grid;
    gap: 0.72rem;
    min-height: 100%;
    transition: border-color 160ms ease, transform 160ms ease, box-shadow 160ms ease;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  }

  .home-social-card[data-provider='x'] {
    --social-accent: #8ac4ff;
  }

  .home-social-card[data-provider='youtube'] {
    --social-accent: #ff8585;
  }

  .home-social-card[data-provider='instagram'] {
    --social-accent: #ffb87a;
  }

  .home-social-card:hover,
  .home-social-card:focus-within {
    border-color: color-mix(in srgb, var(--social-accent) 62%, var(--line2));
    transform: translateY(-2px);
    box-shadow: 0 14px 28px rgba(0, 0, 0, 0.12);
  }

  .home-social-card-kicker {
    margin: 0;
    font-size: 0.66rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: color-mix(in srgb, var(--social-accent) 78%, var(--tone-muted));
  }

  .home-social-card h3 {
    margin: 0;
    font-size: 1.04rem;
    letter-spacing: -0.01em;
  }

  .home-social-card-dek {
    margin: 0;
    color: var(--tone-muted);
    font-size: 0.85rem;
    line-height: 1.52;
  }

  .home-social-frame {
    border: 1px solid var(--line2);
    border-radius: 0.78rem;
    overflow: hidden;
    background: rgba(6, 10, 17, 0.55);
  }

  .home-social-frame-x {
    position: relative;
    min-height: 24.5rem;
  }

  .home-social-frame-youtube {
    min-height: 24.5rem;
  }

  .home-social-frame iframe {
    width: 100%;
    height: 100%;
    min-height: 24.5rem;
    border: 0;
    background: #060911;
  }

  .home-social-frame-x :global(.twitter-timeline) {
    display: block;
    min-height: 24.5rem;
  }

  .home-social-x-fallback {
    display: none;
    min-height: 24.5rem;
    padding: 0.58rem;
  }

  .home-social-frame-x.is-fallback :global(.twitter-timeline) {
    display: none;
  }

  .home-social-frame-x.is-fallback .home-social-x-fallback {
    display: block;
  }

  .home-social-x-fallback p {
    margin: 0;
    font-size: 0.84rem;
    line-height: 1.5;
    color: var(--tone-muted);
    display: flex;
    min-height: calc(24.5rem - 1.16rem);
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .home-social-x-list {
    margin: 0;
    padding: 0.58rem;
    list-style: none;
    display: grid;
    gap: 0.58rem;
  }

  .home-social-x-list li {
    border: 1px solid var(--line2);
    border-radius: 0.66rem;
    padding: 0.58rem 0.62rem;
    background: rgba(6, 10, 17, 0.42);
  }

  .home-social-x-list li a {
    color: #f4f4f5;
    text-decoration: none;
    font-weight: 600;
    line-height: 1.4;
  }

  .home-social-x-list li a:hover,
  .home-social-x-list li a:focus-visible {
    color: var(--tone-accent-glow);
  }

  .home-social-x-meta {
    margin: 0.28rem 0 0;
    font-size: 0.74rem;
    color: var(--tone-muted);
  }

  .home-social-x-summary {
    margin: 0.24rem 0 0;
    font-size: 0.8rem;
    color: rgba(228, 230, 236, 0.9);
    line-height: 1.45;
  }

  .home-social-youtube-status {
    margin: 0;
    font-size: 0.76rem;
    color: var(--tone-muted);
  }

  .home-social-ig-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.42rem;
  }

  .home-social-ig-tile {
    display: block;
    border: 1px solid var(--line2);
    border-radius: 0.62rem;
    overflow: hidden;
    background: rgba(6, 10, 17, 0.45);
  }

  .home-social-ig-tile img {
    display: block;
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
  }

  .home-social-ig-fallback {
    border: 1px dashed var(--line2);
    border-radius: 0.72rem;
    padding: 0.86rem;
    color: var(--tone-muted);
    background: rgba(6, 10, 17, 0.35);
    min-height: 8rem;
    display: flex;
    align-items: center;
  }

  .home-social-ig-fallback p {
    margin: 0;
    font-size: 0.84rem;
    line-height: 1.5;
  }

  .home-social-links {
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.48rem 0.95rem;
    font-size: 0.82rem;
  }

  .home-social-links a {
    color: var(--tone-accent-glow);
    text-decoration: none;
    border-bottom: 1px solid color-mix(in srgb, var(--tone-accent) 38%, transparent);
    transition: color 140ms ease, border-color 140ms ease;
  }

  .home-social-links a:hover,
  .home-social-links a:focus-visible {
    color: color-mix(in srgb, var(--social-accent) 80%, #fff 20%);
    border-color: color-mix(in srgb, var(--social-accent) 70%, transparent);
  }

  @media (min-width: 861px) and (max-width: 1200px) {
    .home-social-feeds {
      margin-top: 2rem;
    }

    .home-social-feeds-header {
      margin-bottom: 0.8rem;
    }

    .home-social-feeds-grid {
      gap: 0.72rem;
    }

    .home-social-card {
      padding: 0.74rem;
      gap: 0.58rem;
      border-radius: 0.82rem;
    }

    .home-social-card h3 {
      font-size: 1rem;
    }

    .home-social-card-dek {
      font-size: 0.8rem;
      line-height: 1.45;
    }

    .home-social-frame {
      border-radius: 0.7rem;
    }

    .home-social-frame-x,
    .home-social-frame-youtube,
    .home-social-frame iframe,
    .home-social-frame-x :global(.twitter-timeline),
    .home-social-x-fallback {
      min-height: 21.5rem;
    }

    .home-social-x-fallback p {
      min-height: calc(21.5rem - 1.16rem);
    }

    .home-social-ig-grid {
      gap: 0.34rem;
    }

    .home-social-links {
      gap: 0.38rem 0.76rem;
      font-size: 0.78rem;
    }
  }

  @media (min-width: 900px) {
    .home-social-feeds-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1420px) {
    .home-social-feeds-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .home-social-card,
    .home-social-links a {
      transition: none;
    }

    .home-social-card:hover,
    .home-social-card:focus-within {
      transform: none;
    }
  }
</style>
