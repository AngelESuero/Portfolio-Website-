---
import type { LinkHubItem } from '../data/linkhub';
import { getEmbedFallbackMessage, getEmbedHeight, resolveEmbed } from '../lib/embed-resolver';

interface Props {
  item: LinkHubItem;
}

const { item } = Astro.props as Props;

const isLinktreeUrl = (urlValue: string): boolean => {
  try {
    const parsed = new URL(urlValue);
    return parsed.hostname.toLowerCase().includes('linktr.ee');
  } catch {
    return false;
  }
};

const resolution = resolveEmbed(item.url, item.preferredEmbed);
const provider = resolution.provider;
const embedUrl = resolution.embedUrl;
const embedHeight = getEmbedHeight(provider);
const isEmbeddable = resolution.embeddable && Boolean(embedUrl);
const isResizableEmbed = provider === 'google_drive' || provider === 'youtube' || provider === 'instagram';
const isExternal = /^https?:\/\//i.test(item.url);
const isLinktree = isLinktreeUrl(item.url);
const fallbackMessage = isLinktree
  ? 'Linktree is your active links hub. Open it to see the full live stack.'
  : getEmbedFallbackMessage(resolution);
---

<article class="card hub-card" data-provider={provider || 'none'}>
  <div class="hub-meta">
    {item.tag && <span class="hub-tag">{item.tag}</span>}
    {item.year && <span class="hub-year">{item.year}</span>}
  </div>

  <h3>{item.title}</h3>

  {isEmbeddable ? (
    <div class="hub-embed">
      <div class:list={['hub-embed-frame', isResizableEmbed && 'is-resizable']} style={`--embed-height:${embedHeight}px`}>
        <iframe
          src={embedUrl || undefined}
          width="100%"
          frameborder="0"
          loading="lazy"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          allowFullScreen
          title={`${item.title} embed`}
        ></iframe>
      </div>
      <p class="hub-note">
        {isResizableEmbed ? 'Drag to resize on desktop. ' : ''}
        If the embed fails, open source below.
      </p>
    </div>
  ) : (
    <div class="reader-frame">
      <p>{fallbackMessage}</p>
    </div>
  )}

  <a class="hub-link" href={item.url} {...(isExternal ? { target: '_blank', rel: 'noopener' } : {})}>
    {isLinktree ? 'Open Linktree' : 'Open source'}
  </a>
</article>

<style>
  .hub-card {
    padding: 0.82rem;
    display: grid;
    gap: 0.68rem;
  }

  .hub-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    min-height: 1.1rem;
  }

  .hub-tag,
  .hub-year {
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--tone-muted);
  }

  .hub-card h3 {
    margin: 0;
    font-size: 1rem;
    line-height: 1.28;
  }

  .hub-embed {
    border: 1px solid var(--line2);
    border-radius: 12px;
    background: rgba(4, 7, 12, 0.62);
  }

  .hub-embed-frame {
    height: var(--embed-height, 300px);
    min-height: 11rem;
    border-radius: 12px 12px 0 0;
    overflow: hidden;
  }

  .hub-embed-frame iframe {
    display: block;
    width: 100%;
    height: 100%;
    border: 0;
    background: #060911;
  }

  @media (pointer: fine) {
    .hub-embed-frame.is-resizable {
      resize: vertical;
      overflow: auto;
      max-height: min(75vh, 720px);
    }
  }

  .hub-note {
    margin: 0;
    padding: 0.42rem 0.58rem;
    font-size: 0.72rem;
    color: var(--tone-muted);
    border-top: 1px solid var(--line2);
  }

  .reader-frame {
    border: 1px dashed var(--line);
    border-radius: 12px;
    padding: 0.75rem;
    color: var(--tone-muted);
    font-size: 0.83rem;
    background: rgba(6, 10, 17, 0.4);
  }

  .reader-frame p {
    margin: 0;
  }

  .hub-link {
    display: inline-flex;
    width: fit-content;
    color: var(--tone-accent-glow);
    text-decoration: none;
    border-bottom: 1px solid color-mix(in srgb, var(--tone-accent) 38%, transparent);
    font-size: 0.84rem;
  }

</style>
