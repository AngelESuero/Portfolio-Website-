---
import BaseLayout from '../layouts/BaseLayout.astro';
import agiEvents from '../data/agi.events.json';

interface AgiEvent {
  date: string;
  type?: string;
  title: string;
  summary: string;
  tags: string[];
  source_url: string;
}

const events = (agiEvents as AgiEvent[])
  .slice()
  .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());

const typeOptions = [...new Set(events.map((event) => (event.type || 'general').toLowerCase()))].sort();
const tagOptions = [...new Set(events.flatMap((event) => event.tags || []).map((tag) => tag.toLowerCase()))].sort();
---

<BaseLayout
  title="AGI Timeline — a_e.s_"
  description="Local-first AGI timeline MVP with source citations and lightweight filters."
  theme="agi"
>
  <section class="agi-mvp">
    <header class="agi-mvp__hero">
      <p class="agi-mvp__kicker">Timeline MVP</p>
      <h1>AGI Timeline</h1>
      <p>
        Citation-first timeline powered by <code>src/data/agi.events.json</code>. Free-first and deploy-safe for Cloudflare
        Pages.
      </p>
    </header>

    <aside class="agi-mvp__todo" aria-label="Automation notes">
      <h2>TODO (optional automation)</h2>
      <ul>
        <li>Add a GitHub Action to refresh <code>src/data/agi.events.json</code> from approved feeds.</li>
        <li>Add schema validation in CI before deploying updated timeline data.</li>
      </ul>
    </aside>

    <div class="agi-mvp__filters" aria-label="Timeline filters">
      <label>
        <span>Type</span>
        <select id="agi-type-filter">
          <option value="">All types</option>
          {typeOptions.map((type) => <option value={type}>{type}</option>)}
        </select>
      </label>

      <label>
        <span>Tag</span>
        <select id="agi-tag-filter">
          <option value="">All tags</option>
          {tagOptions.map((tag) => <option value={tag}>{tag}</option>)}
        </select>
      </label>
    </div>

    <ol id="agi-list" class="agi-mvp__list" aria-live="polite">
      {events.map((event) => (
        <li
          class="agi-mvp__item"
          data-type={(event.type || 'general').toLowerCase()}
          data-tags={event.tags.map((tag) => tag.toLowerCase()).join('|')}
        >
          <article>
            <p class="agi-mvp__meta">
              <time datetime={event.date}>{new Date(event.date).toLocaleDateString()}</time>
              <span aria-hidden="true">•</span>
              <span>{event.type || 'general'}</span>
            </p>
            <h2>{event.title}</h2>
            <p>{event.summary}</p>
            <p class="agi-mvp__tags">{event.tags.map((tag) => `#${tag}`).join(' ')}</p>
            <p class="agi-mvp__source">
              <a href={event.source_url} target="_blank" rel="noopener">Source citation</a>
            </p>
          </article>
        </li>
      ))}
    </ol>

    <p id="agi-empty" class="agi-mvp__empty" hidden>No events match these filters.</p>
  </section>
</BaseLayout>

<script is:inline>
  (() => {
    const typeFilter = document.getElementById('agi-type-filter');
    const tagFilter = document.getElementById('agi-tag-filter');
    const items = Array.from(document.querySelectorAll('.agi-mvp__item'));
    const empty = document.getElementById('agi-empty');
    if (!typeFilter || !tagFilter || !items.length || !empty) return;

    const applyFilters = () => {
      const selectedType = typeFilter.value;
      const selectedTag = tagFilter.value;
      let visibleCount = 0;

      items.forEach((item) => {
        const type = item.getAttribute('data-type') || '';
        const tags = item.getAttribute('data-tags') || '';
        const typeOk = !selectedType || selectedType === type;
        const tagOk = !selectedTag || tags.split('|').includes(selectedTag);
        const visible = typeOk && tagOk;
        item.hidden = !visible;
        if (visible) visibleCount += 1;
      });

      empty.hidden = visibleCount > 0;
    };

    typeFilter.addEventListener('change', applyFilters);
    tagFilter.addEventListener('change', applyFilters);
    applyFilters();
  })();
</script>

<style>
  .agi-mvp {
    max-width: 56rem;
    margin: 0 auto;
  }

  .agi-mvp__kicker {
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.72rem;
    color: var(--tone-muted);
  }

  .agi-mvp__hero h1 {
    margin: 0.35rem 0 0.72rem;
    font-size: clamp(2rem, 4.1vw, 2.9rem);
    line-height: 1.08;
  }

  .agi-mvp__hero p {
    margin: 0;
    max-width: 72ch;
    color: var(--tone-muted);
  }

  .agi-mvp__todo {
    margin-top: 1rem;
    border: 1px solid var(--line);
    border-radius: var(--radius);
    background: var(--panel);
    padding: 0.82rem;
  }

  .agi-mvp__todo h2 {
    margin: 0;
    font-size: 1rem;
  }

  .agi-mvp__todo ul {
    margin: 0.6rem 0 0;
    padding-left: 1.1rem;
  }

  .agi-mvp__filters {
    margin-top: 0.9rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.7rem;
  }

  .agi-mvp__filters label {
    display: grid;
    gap: 0.25rem;
  }

  .agi-mvp__filters span {
    color: var(--tone-muted);
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .agi-mvp__filters select {
    border: 1px solid var(--line);
    border-radius: 0.55rem;
    background: rgba(11, 16, 25, 0.74);
    color: var(--tone-text);
    padding: 0.42rem 0.55rem;
  }

  .agi-mvp__list {
    margin: 1rem 0 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 0.72rem;
  }

  .agi-mvp__item article {
    border: 1px solid var(--line);
    border-radius: var(--radius);
    background: var(--panel);
    padding: 0.85rem;
  }

  .agi-mvp__meta {
    margin: 0;
    display: flex;
    gap: 0.42rem;
    color: var(--tone-muted);
    font-size: 0.8rem;
  }

  .agi-mvp__item h2 {
    margin: 0.52rem 0 0;
    font-size: 1.12rem;
    line-height: 1.3;
  }

  .agi-mvp__item p {
    margin: 0.58rem 0 0;
  }

  .agi-mvp__tags {
    color: var(--tone-muted);
    font-size: 0.82rem;
  }

  .agi-mvp__source a {
    color: var(--tone-accent-glow);
    text-decoration: none;
    border-bottom: 1px solid color-mix(in srgb, var(--tone-accent) 35%, transparent);
  }

  .agi-mvp__empty {
    margin-top: 0.9rem;
    color: var(--tone-muted);
  }
</style>
