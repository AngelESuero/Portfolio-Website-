---
import BaseLayout from '../layouts/BaseLayout.astro';

const seedAgi = {
  meta: { schemaVersion: 1, generatedAt: null, sources: [] },
  items: [
    {
      id: 'seed',
      title: 'AGI timeline seed (data sync not yet populated).',
      url: 'https://github.com/AngelESuero/Portfolio-Website-',
      sourceId: 'seed',
      sourceName: 'Local',
      publishedAt: new Date().toISOString(),
      summary: 'This placeholder guarantees the page never renders empty.',
      tags: ['seed'],
      citations: [{ label: 'Repo', url: 'https://github.com/AngelESuero/Portfolio-Website-' }]
    }
  ]
};

const seedYT = {
  meta: {
    schemaVersion: 1,
    generatedAt: null,
    channelUrl: 'https://www.youtube.com/@a_e.s_4',
    channelId: 'UCQeJiBS72gxrZXw5GmqtocA',
    feedUrl: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCQeJiBS72gxrZXw5GmqtocA'
  },
  items: []
};

async function safeJsonImport(path, fallback) {
  try {
    const mod = await import(path);
    return mod?.default ?? fallback;
  } catch {
    return fallback;
  }
}

const agiData = await safeJsonImport('../data/agi-timeline.json', seedAgi);
const youtubeData = await safeJsonImport('../data/youtube.json', seedYT);

const agiItems = Array.isArray(agiData.items) ? agiData.items : seedAgi.items;
const agiMeta = agiData.meta ?? seedAgi.meta;

const ytItems = Array.isArray(youtubeData.items) ? youtubeData.items : [];
const ytMeta = youtubeData.meta ?? seedYT.meta;

const allSources = Array.from(new Set(agiItems.map((i) => i.sourceName).filter(Boolean))).sort();
const allTags = Array.from(new Set(agiItems.flatMap((i) => i.tags ?? []))).sort();

const allSeries = Array.from(new Set(ytItems.flatMap((v) => v.series ?? []))).sort();
---

<BaseLayout title="AGI Timeline" description="Living archive AGI timeline with cached feeds." theme="agi">
  <section class="mx-auto max-w-4xl px-4 py-10">
    <header class="space-y-3">
      <h1 class="text-2xl font-semibold tracking-tight">AGI Timeline</h1>
      <p class="text-sm opacity-80">Living archive. Cached dataset (build-time). Process over polish.</p>

      <div class="flex flex-wrap items-center gap-3 text-xs opacity-80">
        <span class="font-mono">Last updated: {agiMeta.generatedAt ?? 'unknown'}</span>
        <span class="font-mono">Entries: {agiItems.length}</span>
      </div>
    </header>

    <div class="mt-6 grid gap-3 rounded-xl border border-white/10 p-4">
      <div class="grid gap-3 md:grid-cols-3">
        <label class="grid gap-1">
          <span class="text-xs opacity-70">Search</span>
          <input
            id="agiSearch"
            class="rounded-lg border border-white/10 bg-transparent px-3 py-2 text-sm"
            placeholder="title / summary / tag..."
          />
        </label>

        <label class="grid gap-1">
          <span class="text-xs opacity-70">Source</span>
          <select id="agiSource" class="rounded-lg border border-white/10 bg-transparent px-3 py-2 text-sm">
            <option value="">All sources</option>
            {allSources.map((s) => <option value={s}>{s}</option>)}
          </select>
        </label>

        <div class="grid gap-1">
          <span class="text-xs opacity-70">Tags</span>
          <details class="rounded-lg border border-white/10 p-2">
            <summary class="cursor-pointer text-sm opacity-80">Toggle tags</summary>
            <div class="mt-2 flex flex-wrap gap-2">
              {allTags.map((t) => (
                <label class="inline-flex items-center gap-2 rounded-full border border-white/10 px-3 py-1 text-xs">
                  <input class="agiTag" type="checkbox" value={t} />
                  <span>{t}</span>
                </label>
              ))}
            </div>
          </details>
        </div>
      </div>

      <div class="flex items-center justify-between">
        <div class="font-mono text-xs opacity-70">
          Showing <span id="agiShown">0</span> / <span id="agiTotal">{agiItems.length}</span>
        </div>
        <button id="agiReset" class="rounded-lg border border-white/10 px-3 py-2 text-xs">Reset</button>
      </div>
    </div>

    <div id="agiList" class="mt-6 space-y-3">
      {agiItems.map((item) => {
        const text = `${item.title ?? ''} ${item.summary ?? ''} ${(item.tags ?? []).join(' ')} ${item.sourceName ?? ''}`.toLowerCase();
        const tagStr = (item.tags ?? []).join('|');
        return (
          <details
            class="agiItem rounded-xl border border-white/10 p-4"
            data-source={item.sourceName ?? ''}
            data-tags={tagStr}
            data-text={text}
          >
            <summary class="list-none cursor-pointer">
              <div class="flex flex-wrap items-baseline justify-between gap-2">
                <div class="space-y-1">
                  <div class="text-sm font-medium">{item.title ?? 'Untitled'}</div>
                  <div class="font-mono text-xs opacity-70">
                    {item.publishedAt ? new Date(item.publishedAt).toISOString().slice(0, 10) : 'unknown date'}
                    {' · '}
                    {item.sourceName ?? 'Unknown source'}
                  </div>
                </div>
                <a class="text-xs opacity-80 underline" href={item.url} target="_blank" rel="noreferrer">
                  Open
                </a>
              </div>
            </summary>

            {item.summary && <p class="mt-3 text-sm opacity-90">{item.summary}</p>}

            <div class="mt-3 flex flex-wrap gap-2">
              {(item.tags ?? []).map((t) => (
                <span class="rounded-full border border-white/10 px-3 py-1 text-xs opacity-80">{t}</span>
              ))}
            </div>

            <div class="mt-3 space-y-1">
              <div class="text-xs opacity-70">Citations</div>
              <ul class="list-inside list-disc text-xs">
                {(item.citations ?? []).map((c) => (
                  <li>
                    <a class="underline" href={c.url} target="_blank" rel="noreferrer">{c.label}</a>
                  </li>
                ))}
              </ul>
            </div>
          </details>
        );
      })}
    </div>

    <div id="agiEmpty" class="mt-6 hidden rounded-xl border border-white/10 p-4 text-sm opacity-80">
      No matches. Try clearing filters.
    </div>

    <hr class="my-12 border-white/10" />

    <section class="space-y-4">
      <header class="space-y-2">
        <h2 class="text-xl font-semibold tracking-tight">Latest uploads</h2>
        <div class="font-mono text-xs opacity-80">
          Feed:
          <a class="underline" href={ytMeta.feedUrl} target="_blank" rel="noreferrer">{ytMeta.feedUrl}</a>
        </div>
      </header>

      <div class="grid gap-3 rounded-xl border border-white/10 p-4">
        <label class="grid gap-1 md:max-w-xs">
          <span class="text-xs opacity-70">Series</span>
          <select id="ytSeries" class="rounded-lg border border-white/10 bg-transparent px-3 py-2 text-sm">
            <option value="">All</option>
            {allSeries.map((s) => <option value={s}>{s}</option>)}
          </select>
        </label>

        <div id="ytPlayerWrap" class="hidden rounded-xl border border-white/10 p-3">
          <div class="flex items-center justify-between gap-2">
            <div id="ytPlayerTitle" class="text-sm font-medium"></div>
            <button id="ytClose" class="text-xs opacity-80 underline">Close</button>
          </div>
          <div class="mt-3 aspect-video w-full overflow-hidden rounded-lg border border-white/10">
            <iframe
              id="ytPlayer"
              class="h-full w-full"
              src=""
              title="YouTube player"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            />
          </div>
        </div>
      </div>

      <div id="ytGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {ytItems.map((v) => {
          const series = (v.series ?? []).join('|');
          return (
            <button
              class="ytCard rounded-xl border border-white/10 p-3 text-left hover:border-white/20"
              data-video={v.videoId ?? ''}
              data-title={v.title ?? ''}
              data-series={series}
            >
              <div class="aspect-video w-full overflow-hidden rounded-lg border border-white/10">
                <img class="h-full w-full object-cover" src={v.thumbnailUrl ?? ''} alt={v.title ?? 'Video thumbnail'} loading="lazy" />
              </div>
              <div class="mt-3 space-y-1">
                <div class="text-sm font-medium">{v.title ?? 'Untitled'}</div>
                <div class="font-mono text-xs opacity-70">
                  {v.publishedAt ? new Date(v.publishedAt).toISOString().slice(0, 10) : 'unknown date'}
                  {v.series?.length ? ` · ${v.series.join(', ')}` : ''}
                </div>
              </div>
            </button>
          );
        })}
      </div>
    </section>
  </section>

  <script type="module" is:inline>
    const $ = (id) => document.getElementById(id);

    const search = $('agiSearch');
    const sourceSel = $('agiSource');
    const resetBtn = $('agiReset');
    const shownEl = $('agiShown');
    const totalEl = $('agiTotal');
    const emptyEl = $('agiEmpty');

    const tagBoxes = Array.from(document.querySelectorAll('.agiTag'));
    const items = Array.from(document.querySelectorAll('.agiItem'));

    function selectedTags() {
      return tagBoxes.filter((b) => b.checked).map((b) => b.value);
    }

    function applyFilters() {
      const q = (search.value || '').trim().toLowerCase();
      const src = sourceSel.value || '';
      const tags = selectedTags();

      let shown = 0;

      for (const el of items) {
        const elSrc = el.dataset.source || '';
        const elTags = (el.dataset.tags || '').split('|').filter(Boolean);
        const elText = el.dataset.text || '';

        const okQ = !q || elText.includes(q);
        const okSrc = !src || elSrc === src;
        const okTags = tags.length === 0 || tags.every((t) => elTags.includes(t));

        const ok = okQ && okSrc && okTags;
        el.hidden = !ok;
        if (ok) shown += 1;
      }

      shownEl.textContent = String(shown);
      totalEl.textContent = String(items.length);
      emptyEl.classList.toggle('hidden', shown !== 0);
    }

    [search, sourceSel].forEach((el) => el.addEventListener('input', applyFilters));
    tagBoxes.forEach((b) => b.addEventListener('change', applyFilters));
    resetBtn.addEventListener('click', () => {
      search.value = '';
      sourceSel.value = '';
      tagBoxes.forEach((b) => {
        b.checked = false;
      });
      applyFilters();
    });

    applyFilters();

    const ytSeries = $('ytSeries');
    const ytCards = Array.from(document.querySelectorAll('.ytCard'));
    const playerWrap = $('ytPlayerWrap');
    const player = $('ytPlayer');
    const playerTitle = $('ytPlayerTitle');
    const ytClose = $('ytClose');

    function applyYTFilter() {
      const series = ytSeries.value || '';
      for (const c of ytCards) {
        const has = (c.dataset.series || '').split('|').includes(series);
        c.hidden = !!series && !has;
      }
    }

    ytSeries.addEventListener('change', applyYTFilter);
    applyYTFilter();

    function openYT(videoId, title) {
      if (!videoId) return;
      player.src = 'https://www.youtube-nocookie.com/embed/' + encodeURIComponent(videoId);
      playerTitle.textContent = title || 'Now playing';
      playerWrap.classList.remove('hidden');
      playerWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    ytCards.forEach((c) => {
      c.addEventListener('click', () => openYT(c.dataset.video, c.dataset.title));
    });

    ytClose.addEventListener('click', () => {
      player.src = '';
      playerWrap.classList.add('hidden');
    });
  </script>
</BaseLayout>
