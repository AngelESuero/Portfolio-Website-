---
import BaseLayout from '../layouts/BaseLayout.astro';
import profile from '../data/profile';
import featuredThreads from '../data/featured_threads.json';
import { getCollection } from 'astro:content';
import MobileTOC from '../components/MobileTOC.astro';
import UntitledPlayer from '../components/UntitledPlayer.astro';
import EmbedCard from '../components/EmbedCard.astro';
import HomeTabReflections from '../components/HomeTabReflections.astro';
import HomeSocialFeeds from '../components/HomeSocialFeeds.astro';
import { LINK_HUB_CATEGORIES, type LinkHubItem } from '../data/linkhub';
import igManifest from '../data/ig.json';
import youtubeManifest from '../data/youtube.json';
import xFeedManifest from '../data/x-feed.json';

interface YoutubeFeedItem {
  videoId?: string;
}

interface YoutubeFeedManifest {
  items?: YoutubeFeedItem[];
}

interface XFeedItem {
  id?: string;
  title?: string;
  url?: string;
  publishedAt?: string;
  summary?: string;
}

interface XFeedManifest {
  items?: XFeedItem[];
}
import rooms from '../data/rooms';
import agiTimelineData from '../data/agi-timeline.json';

const allProjects = await getCollection('projects');
const allPosts = (await getCollection('posts')).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const posts = allPosts.slice(0, 3);
const tools = [...new Set(allProjects.flatMap((project) => project.data.tools))].slice(0, 10);
const threads = featuredThreads.featured_threads;
const categoryItems = new Map(LINK_HUB_CATEGORIES.map((category) => [category.id, category.items]));
const pickItems = (categoryId: string, ids: string[]): LinkHubItem[] => {
  const items = categoryItems.get(categoryId) || [];
  return ids
    .map((id) => items.find((item) => item.id === id))
    .filter((item): item is LinkHubItem => Boolean(item));
};

const nowListeningItem = pickItems('music', ['now-listening'])[0];
const sectionEmbeds = [
  {
    id: 'music',
    label: 'Music',
    color: 'blue',
    items: pickItems('music', ['now-listening', 'my-first-beat-tape', 'everyday-soundscape']).concat(
      pickItems('resources', ['practicing-kriya'])
    )
  },
  {
    id: 'visual',
    label: 'Visual',
    color: 'orange',
    items: pickItems('social', ['instagram', 'threads', 'tiktok'])
  },
  {
    id: 'video',
    label: 'Video',
    color: 'red',
    items: pickItems('video', ['everyday-life-video', 'youtube-channel', 'post-labor-econ-playlist'])
  },
  {
    id: 'newark',
    label: 'Newark',
    color: 'yellow',
    items: pickItems('resources', ['work-archive', 'map', 'mit-living-wage'])
  },
  {
    id: 'scraps',
    label: 'Scraps',
    color: 'white',
    items: pickItems('music', ['scraps-2023-2024']).concat(
      pickItems('writing', ['writing-archive', 'substack', 'magazine-publication'])
    )
  }
];
const shortDateFormatter = new Intl.DateTimeFormat('en-US', {
  month: 'short',
  day: 'numeric',
  year: 'numeric'
});
const pluralize = (count: number, singular: string, plural = `${singular}s`) => `${count} ${count === 1 ? singular : plural}`;
const formatDateLabel = (value: unknown, fallback: string): string => {
  let parsed: Date | null = null;

  if (value instanceof Date) {
    parsed = Number.isNaN(value.valueOf()) ? null : value;
  } else if (typeof value === 'string' || typeof value === 'number') {
    const candidate = new Date(value);
    parsed = Number.isNaN(candidate.valueOf()) ? null : candidate;
  }

  return parsed ? shortDateFormatter.format(parsed) : fallback;
};

const projectCount = allProjects.length;
const projectTypeCount = new Set(allProjects.map((project) => project.data.type)).size;
const postCount = allPosts.length;
const latestPostDateLabel = formatDateLabel(allPosts[0]?.data?.date, 'recently');
const roomList = Array.isArray(rooms) ? rooms : [];
const roomCount = roomList.length;
const machineCount = roomList.reduce((count, room) => count + (Array.isArray(room.machines) ? room.machines.length : 0), 0);
const agiSignalCount = Array.isArray(agiTimelineData?.items) ? agiTimelineData.items.length : 0;
const agiUpdatedAtLabel = formatDateLabel(agiTimelineData?.meta?.generatedAt, 'Updated recently');
const reflectionItems = [
  {
    id: 'work',
    title: 'Work',
    href: '/work',
    summary:
      projectCount > 0
        ? `${pluralize(projectCount, 'project')} across ${pluralize(projectTypeCount, 'type')}.`
        : 'No projects indexed yet.',
    meta: projectCount > 0 ? `Coverage: ${pluralize(projectTypeCount, 'type')}` : 'Coverage pending',
    cta: 'Open Work'
  },
  {
    id: 'writing',
    title: 'Writing',
    href: '/writing',
    summary:
      postCount > 0 ? `${pluralize(postCount, 'entry', 'entries')} published. Latest ${latestPostDateLabel}.` : 'No entries yet.',
    meta: postCount > 0 ? `Latest update ${latestPostDateLabel}` : 'Latest update pending',
    cta: 'Open Writing'
  },
  {
    id: 'social',
    title: 'Social',
    href: '/social',
    summary: `${pluralize(roomCount, 'room')} and ${pluralize(machineCount, 'machine')} mapped in the arcade.`,
    meta: `Index: ${pluralize(roomCount, 'room')}`,
    cta: 'Open Social'
  },
  {
    id: 'agi',
    title: 'AGI Timeline',
    href: '/agi',
    summary: agiSignalCount > 0 ? `${pluralize(agiSignalCount, 'signal')} tracked in the monitor.` : 'No AGI signals indexed yet.',
    meta: `Last sync ${agiUpdatedAtLabel}`,
    cta: 'Open AGI Timeline'
  },
  {
    id: 'contact',
    title: 'Contact',
    href: '/contact',
    summary: 'Inquiry form plus 4 quick links for direct outreach.',
    meta: 'Channels: form + socials',
    cta: 'Open Contact'
  }
];
const xHandle = 'a_e_s_4';
const youtubeChannelId = 'UCQeJiBS72gxrZXw5GmqtocA';
const youtubeUploadsPlaylistId = `UU${youtubeChannelId.slice(2)}`;
const ytManifest = youtubeManifest as YoutubeFeedManifest;
const xManifest = xFeedManifest as XFeedManifest;
const xPublishedAtToTimestamp = (value: string): number => {
  const parsed = Date.parse(value);
  return Number.isNaN(parsed) ? 0 : parsed;
};
const xFeedItems = (Array.isArray(xManifest.items) ? xManifest.items : [])
  .map((item) => ({
    title: String(item?.title || '').trim(),
    url: String(item?.url || '').trim(),
    publishedAt: String(item?.publishedAt || '').trim(),
    summary: String(item?.summary || '').trim()
  }))
  .filter((item) => item.title && item.url)
  .sort((a, b) => xPublishedAtToTimestamp(b.publishedAt) - xPublishedAtToTimestamp(a.publishedAt))
  .slice(0, 6);
const youtubeLatestVideoId = Array.isArray(ytManifest.items)
  ? ytManifest.items
      .map((item) => (typeof item?.videoId === 'string' ? item.videoId.trim() : ''))
      .find((value) => value.length > 0) || ''
  : '';
const youtubeUploadsEmbedUrl = youtubeLatestVideoId
  ? `https://www.youtube.com/embed/${youtubeLatestVideoId}`
  : `https://www.youtube.com/embed/videoseries?list=${youtubeUploadsPlaylistId}`;
const instagramPreview = (Array.isArray(igManifest) ? igManifest : [])
  .filter((item) => typeof item?.src === 'string' && item.src)
  .slice(0, 4)
  .map((item) => ({
    src: String(item.src),
    caption: typeof item.caption === 'string' ? item.caption : '',
    date: typeof item.date === 'string' ? item.date : ''
  }));
---

<BaseLayout title="A Path Toward Life — Archive" description={profile.short_bio} theme="archive">
  <div class="desktop-home">
    <section class="space-y-6 text-center">
      <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Timeline / Archive</p>
      <h1 class="mx-auto max-w-3xl font-display text-4xl font-bold md:text-6xl text-accent">A Path Toward Life</h1>
      <p class="mx-auto max-w-4xl text-lg">{profile.long_bio}</p>
      <div class="flex flex-wrap justify-center gap-2" aria-label="Identity chips">
        {profile.roles.map((role) => <span class="chip rounded-full px-3 py-1 text-sm">{role}</span>)}
      </div>
    </section>

    <section class="mt-12 md:mt-14">
      <h2 class="font-display text-2xl">Featured Threads</h2>
      <div class="mt-4 flex gap-4 overflow-x-auto pb-2 md:grid md:grid-cols-3 md:overflow-visible">
        {threads.map((thread) => (
          <a
            href={thread.href}
            class="card threadCard min-w-[270px] p-4"
            {...(thread.external ? { target: '_blank', rel: 'noopener' } : {})}
          >
            <p class="text-xs uppercase tracking-wide text-zinc-500">{thread.year} · {thread.type}</p>
            <h3 class="mt-1 font-display text-lg">{thread.title}</h3>
            <p class="mt-2 text-sm">{thread.blurb}</p>
            <p class="mt-3 text-sm underline decoration-accent">View thread</p>
          </a>
        ))}
      </div>
    </section>

    <HomeTabReflections items={reflectionItems} sectionTitle="Tab Reflections" variant="desktop" />

    <section class="mt-12 md:mt-14">
      <h2 class="font-display text-2xl">Sections</h2>
      <div class="mt-3 section-tablist" role="tablist" aria-label="Section spotlight tabs">
        {sectionEmbeds.map((section, index) => (
          <button
            type="button"
            role="tab"
            data-section-tab={section.id}
            data-color={section.color}
            aria-selected={index === 0 ? 'true' : 'false'}
            class:list={['section-tab', index === 0 && 'is-active']}
          >
            {section.label}
          </button>
        ))}
      </div>

      <div class="mt-4 section-panels">
        {sectionEmbeds.map((section, index) => (
          <div
            class:list={['section-panel', index === 0 && 'is-active']}
            data-section-panel={section.id}
            role="tabpanel"
            aria-label={`${section.label} spotlight`}
          >
            {section.items.length > 0 ? (
              <div class="section-cards">
                {section.items.map((item) => (
                  <div class="section-card-shell">
                    <EmbedCard item={item} showResizeHint={true} />
                  </div>
                ))}
              </div>
            ) : (
              <p class="text-sm text-zinc-400">No spotlight links configured yet.</p>
            )}
          </div>
        ))}
      </div>
    </section>

    <HomeSocialFeeds
      xHandle={xHandle}
      xFeedItems={xFeedItems}
      youtubeUploadsEmbedUrl={youtubeUploadsEmbedUrl}
      youtubeChannelUrl={profile.social_links.youtube}
      instagramProfileUrl={profile.social_links.instagram}
      instagramArchiveUrl="/instagram"
      instagramPreview={instagramPreview}
    />

    <UntitledPlayer title="Listen" subtitle="untitled.stream" />
    {nowListeningItem && (
      <section class="mt-4">
        <h2 class="mb-3 font-display text-xl">Now Listening</h2>
        <EmbedCard item={nowListeningItem} />
      </section>
    )}
  </div>

  <article class="mobile-editorial" aria-label="Mobile editorial layout">
    <header class="mobile-hero" id="home">
      <p class="mobile-kicker">Timeline / Archive</p>
      <h1><span class="mobile-accent">A Path Toward Life</span></h1>
      <p class="mobile-dek">{profile.long_bio}</p>
      <div class="mobile-role-row" aria-label="Identity chips">
        {profile.roles.map((role) => <span>{role}</span>)}
      </div>
    </header>

    <MobileTOC />
    <HomeTabReflections items={reflectionItems} sectionTitle="Tab Reflections" variant="mobile" />

    <section id="about" class="mobile-story-section">
      <h2>About</h2>
      <p>{profile.short_bio}</p>
      <p>{profile.long_bio}</p>
    </section>

    <section id="work" class="mobile-story-section">
      <h2>Work / Projects</h2>
      <ul class="mobile-project-list">
        {threads.map((thread) => (
          <li>
            <a href={thread.href} {...(thread.external ? { target: '_blank', rel: 'noopener' } : {})}>{thread.title}</a>
            <p>{thread.blurb}</p>
            <p class="meta">{thread.year} · {thread.type}</p>
          </li>
        ))}
      </ul>
    </section>

    <section id="experience" class="mobile-story-section">
      <h2>Experience</h2>
      <p>Built cross-disciplinary work streams in music production, visual storytelling, and civic collaboration across Newark communities.</p>
      <p>Current focus: documenting process in public, shipping creative studies, and evolving this archive into a living portfolio timeline.</p>
    </section>

    <section id="skills" class="mobile-story-section">
      <h2>Skills / Tools</h2>
      <div class="mobile-pill-grid">
        {tools.map((tool) => <span>{tool}</span>)}
      </div>
    </section>

    <section id="media" class="mobile-story-section">
      <h2>Media</h2>
      <ul class="mobile-post-list">
        {posts.map((post) => (
          <li>
            <a href={`/writing/${post.slug}`}>{post.data.title}</a>
            <p>{post.data.summary}</p>
          </li>
        ))}
      </ul>
    </section>

    <section id="resume" class="mobile-story-section">
      <h2>Resume / CV</h2>
      <p>For speaking, collaborations, and portfolio details, use the press kit and updated project index.</p>
      <p><a href="/press-kit">Open press kit</a></p>
    </section>

    <section id="contact" class="mobile-story-section">
      <h2>Contact</h2>
      <p>Use the form for inquiries, collaborations, and project commissions.</p>
      <p><a href="/contact">Open contact form</a></p>
    </section>

    <section id="social-feeds" class="mobile-story-section">
      <h2>Social feeds</h2>
      <p>Quick feed jump links for X, YouTube uploads, and the local Instagram archive.</p>
      <ul class="mobile-social-feed-cards">
        <li>
          <a href="/social/x" class="mobile-social-card mobile-social-card-x">
            <strong>X</strong>
            <span>Latest notes and commentary from @{xHandle}.</span>
          </a>
        </li>
        <li>
          <a href="/social/youtube" class="mobile-social-card mobile-social-card-youtube">
            <strong>YouTube</strong>
            <span>Newest uploads and featured videos.</span>
          </a>
        </li>
        <li>
          <a href="/social/instagram" class="mobile-social-card mobile-social-card-instagram">
            <strong>Instagram</strong>
            <span>Local-first preview feed with full archive at /instagram.</span>
          </a>
        </li>
      </ul>
    </section>

    <section id="links" class="mobile-story-section">
      <h2>Links</h2>
      <ul class="mobile-link-list">
        <li><a href={profile.social_links.instagram}>Instagram</a></li>
        <li><a href={profile.social_links.youtube}>YouTube</a></li>
        <li><a href={profile.social_links.discord}>Discord</a></li>
        <li><a href={profile.link_hub_url}>Link hub</a></li>
      </ul>
    </section>
  </article>

  <script is:inline>
    (() => {
      const tabs = Array.from(document.querySelectorAll('[data-section-tab]'));
      const panels = Array.from(document.querySelectorAll('[data-section-panel]'));
      if (!tabs.length || !panels.length) return;

      const activate = (id, syncAccent = true) => {
        tabs.forEach((tab) => {
          const active = tab.getAttribute('data-section-tab') === id;
          tab.classList.toggle('is-active', active);
          tab.setAttribute('aria-selected', String(active));
        });
        panels.forEach((panel) => {
          const active = panel.getAttribute('data-section-panel') === id;
          panel.classList.toggle('is-active', active);
        });

        if (!syncAccent) return;
        const activeTab = tabs.find((tab) => tab.getAttribute('data-section-tab') === id);
        const color = activeTab?.getAttribute('data-color') || 'blue';
        window.__setSiteAccent?.(color, { animate: true, duration: 250 });
      };

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const id = tab.getAttribute('data-section-tab');
          if (id) activate(id);
        });
      });

      const first = tabs[0]?.getAttribute('data-section-tab');
      if (first) activate(first, false);
    })();
  </script>
</BaseLayout>

<style>
  .section-tablist {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: clamp(0.8rem, 1.3vw, 1.3rem);
    border-bottom: 1px solid var(--line2);
    padding-bottom: 0.12rem;
  }

  .section-tab {
    position: relative;
    display: inline-flex;
    align-items: center;
    min-height: 42px;
    padding: 0;
    border: 0;
    border-radius: 0;
    background: transparent;
    box-shadow: none;
    backdrop-filter: none;
    background: color-mix(in oklab, var(--tone-accent) 0%, transparent);
    color: color-mix(in srgb, var(--tone-text) 88%, var(--tone-muted) 12%);
    font-size: 0.875rem;
    cursor: pointer;
    transition:
      color var(--motion-fast) var(--ease-standard),
      background-color var(--motion-base) var(--ease-standard),
      transform var(--motion-fast) var(--ease-emphasized);
  }

  .section-tab::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: 8px;
    height: 1px;
    transform: scaleX(0);
    transform-origin: left center;
    background: color-mix(in srgb, var(--tone-accent) 82%, #fff 18%);
    opacity: 0.8;
    transition:
      transform var(--motion-fast) var(--ease-emphasized),
      background-color var(--motion-base) var(--ease-standard);
  }

  .section-tab:hover,
  .section-tab:focus-visible,
  .section-tab.is-active {
    color: var(--tone-accent-glow);
    background: color-mix(in srgb, var(--tone-accent) 16%, transparent);
    transform: translateY(-1px);
  }

  .section-tab:hover::after,
  .section-tab:focus-visible::after,
  .section-tab.is-active::after {
    transform: scaleX(1);
  }

  .section-tab:focus-visible {
    outline: 2px solid color-mix(in srgb, var(--tone-accent) 85%, transparent);
    outline-offset: 3px;
    border-radius: 0.35rem;
  }

  .section-panel {
    display: none;
    overflow-x: visible;
  }

  .section-panel.is-active {
    display: block;
  }

  .section-cards {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 0.75rem;
    align-items: flex-start;
    width: min(100%, 78rem);
    margin-inline: auto;
    min-width: 0;
  }

  .section-card-shell {
    flex: 0 0 auto;
    width: clamp(20rem, 31vw, 34rem);
    min-width: min(100%, 20rem);
    max-width: 100%;
  }

  @media (pointer: fine) {
    .section-card-shell {
      resize: both;
      overflow: auto;
      min-width: 20rem;
      min-height: 20rem;
      max-width: min(1400px, 96vw);
      max-height: min(90vh, 1100px);
    }
  }

  .section-card-shell :global(.hub-card) {
    height: 100%;
  }

  .section-card-shell :global(.hub-embed) {
    min-width: 100%;
  }

  @media (max-width: 860px) {
    .mobile-social-feed-cards {
      list-style: none;
      margin: 1rem 0 0;
      padding: 0;
      display: grid;
      gap: 0.72rem;
    }

    .mobile-social-feed-cards li {
      margin: 0;
    }

    .mobile-social-feed-cards a {
      --card-accent: rgba(214, 168, 53, 0.52);
      position: relative;
      display: grid;
      gap: 0.38rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 0.76rem;
      padding: 0.68rem 0.74rem;
      text-decoration: none;
      background:
        linear-gradient(180deg, color-mix(in srgb, var(--card-accent) 16%, transparent) 0%, rgba(255, 255, 255, 0.04) 56%),
        rgba(255, 255, 255, 0.04);
      color: rgba(238, 244, 255, 0.95);
      transition: border-color 140ms ease, color 140ms ease, background-color 140ms ease, transform 140ms ease;
    }

    .mobile-social-card-x {
      --card-accent: rgba(138, 196, 255, 0.68);
    }

    .mobile-social-card-youtube {
      --card-accent: rgba(255, 133, 133, 0.7);
    }

    .mobile-social-card-instagram {
      --card-accent: rgba(255, 184, 122, 0.72);
    }

    .mobile-social-feed-cards a strong {
      font-size: 0.95rem;
      line-height: 1.2;
    }

    .mobile-social-feed-cards a span {
      font-size: 0.86rem;
      line-height: 1.46;
      color: rgba(220, 230, 247, 0.9);
    }

    .mobile-social-feed-cards a::after {
      content: '→';
      position: absolute;
      right: 0.72rem;
      top: 0.66rem;
      font-size: 0.86rem;
      opacity: 0.78;
      color: color-mix(in srgb, var(--card-accent) 78%, #ffffff 22%);
    }

    .mobile-social-feed-cards a:hover,
    .mobile-social-feed-cards a:focus-visible {
      border-color: var(--card-accent);
      color: var(--tone-accent);
      background:
        linear-gradient(180deg, color-mix(in srgb, var(--card-accent) 28%, transparent) 0%, rgba(255, 255, 255, 0.08) 58%),
        rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    @media (prefers-reduced-motion: reduce) {
      .mobile-social-feed-cards a {
        transition: none;
      }

      .mobile-social-feed-cards a:hover,
      .mobile-social-feed-cards a:focus-visible {
        transform: none;
      }
    }
  }
</style>
