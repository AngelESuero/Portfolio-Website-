---
import BaseLayout from '../layouts/BaseLayout.astro';
import profile from '../data/profile.json';
import featuredThreads from '../data/featured_threads.json';
import { getCollection } from 'astro:content';
import MobileTOC from '../components/MobileTOC.astro';
import UntitledPlayer from '../components/UntitledPlayer.astro';
import EmbedCard from '../components/EmbedCard.astro';
import { LINK_HUB_CATEGORIES } from '../data/linkhub';

const allProjects = await getCollection('projects');
const posts = (await getCollection('posts'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);
const tools = [...new Set(allProjects.flatMap((project) => project.data.tools))].slice(0, 10);
const threads = featuredThreads.featured_threads;
const musicCategory = LINK_HUB_CATEGORIES.find((category) => category.id === 'music');
const nowListeningItem = musicCategory?.items.find((item) => item.id === 'now-listening');
const videoCategory = LINK_HUB_CATEGORIES.find((category) => category.id === 'video');
const writingCategory = LINK_HUB_CATEGORIES.find((category) => category.id === 'writing');
const resourcesCategory = LINK_HUB_CATEGORIES.find((category) => category.id === 'resources');
const socialCategory = LINK_HUB_CATEGORIES.find((category) => category.id === 'social');

const sectionEmbeds = [
  {
    id: 'music',
    label: 'Music',
    items: musicCategory?.items ?? []
  },
  {
    id: 'visual',
    label: 'Visual',
    items: (socialCategory?.items || []).filter((item) => ['instagram', 'discord'].includes(item.id))
  },
  {
    id: 'video',
    label: 'Video',
    items: videoCategory?.items ?? []
  },
  {
    id: 'newark',
    label: 'Newark',
    items: (resourcesCategory?.items || []).filter((item) => ['map', 'press-kit'].includes(item.id))
  },
  {
    id: 'scraps',
    label: 'Scraps',
    items: (writingCategory?.items || []).filter((item) => ['writing-archive', 'substack', 'rss-feed'].includes(item.id))
  }
];
---

<BaseLayout title="a_e.s_ — Archive" description={profile.short_bio} theme="archive">
  <div class="desktop-home">
    <section class="space-y-6">
      <p class="text-xs uppercase tracking-[0.2em] text-zinc-500">Timeline / Archive</p>
      <h1 class="max-w-3xl font-display text-4xl font-bold md:text-6xl text-accent">a_e.s_</h1>
      <p class="max-w-3xl text-lg">{profile.long_bio}</p>
      <div class="flex flex-wrap gap-2" aria-label="Identity chips">
        {profile.roles.map((role) => <span class="chip rounded-full px-3 py-1 text-sm">{role}</span>)}
      </div>
    </section>

    <section class="mt-10">
      <h2 class="font-display text-2xl">Featured Threads</h2>
      <div class="mt-4 flex gap-4 overflow-x-auto pb-2 md:grid md:grid-cols-3 md:overflow-visible">
        {threads.map((thread) => (
          <a
            href={thread.href}
            class="card threadCard min-w-[270px] p-4"
            {...(thread.external ? { target: '_blank', rel: 'noopener' } : {})}
          >
            <p class="text-xs uppercase tracking-wide text-zinc-500">{thread.year} · {thread.type}</p>
            <h3 class="mt-1 font-display text-lg">{thread.title}</h3>
            <p class="mt-2 text-sm">{thread.blurb}</p>
            <p class="mt-3 text-sm underline decoration-accent">View thread</p>
          </a>
        ))}
      </div>
    </section>

    <section class="mt-10">
      <h2 class="font-display text-2xl">Sections</h2>
      <div class="mt-3 flex flex-wrap gap-2" role="tablist" aria-label="Section spotlight tabs">
        {sectionEmbeds.map((section, index) => (
          <button
            type="button"
            role="tab"
            data-section-tab={section.id}
            aria-selected={index === 0 ? 'true' : 'false'}
            class:list={['tag rounded px-3 py-1.5 text-sm section-tab', index === 0 && 'is-active']}
          >
            {section.label}
          </button>
        ))}
      </div>

      <div class="mt-4 section-panels">
        {sectionEmbeds.map((section, index) => (
          <div
            class:list={['section-panel', index === 0 && 'is-active']}
            data-section-panel={section.id}
            role="tabpanel"
            aria-label={`${section.label} spotlight`}
          >
            {section.items.length > 0 ? (
              <div class="grid gap-3 md:grid-cols-2">
                {section.items.map((item) => (
                  <EmbedCard item={item} />
                ))}
              </div>
            ) : (
              <p class="text-sm text-zinc-400">No spotlight links configured yet.</p>
            )}
          </div>
        ))}
      </div>
    </section>

    <UntitledPlayer title="Listen" subtitle="untitled.stream" />
    {nowListeningItem && (
      <section class="mt-4">
        <h2 class="mb-3 font-display text-xl">Now Listening</h2>
        <EmbedCard item={nowListeningItem} />
      </section>
    )}
  </div>

  <article class="mobile-editorial" aria-label="Mobile editorial layout">
    <header class="mobile-hero" id="home">
      <p class="mobile-kicker">Timeline / Archive</p>
      <h1><span class="mobile-accent">a_e.s_</span></h1>
      <p class="mobile-dek">{profile.long_bio}</p>
      <div class="mobile-role-row" aria-label="Identity chips">
        {profile.roles.map((role) => <span>{role}</span>)}
      </div>
    </header>

    <MobileTOC />

    <section id="about" class="mobile-story-section">
      <h2>About</h2>
      <p>{profile.short_bio}</p>
      <p>{profile.long_bio}</p>
    </section>

    <section id="work" class="mobile-story-section">
      <h2>Work / Projects</h2>
      <ul class="mobile-project-list">
        {threads.map((thread) => (
          <li>
            <a href={thread.href} {...(thread.external ? { target: '_blank', rel: 'noopener' } : {})}>{thread.title}</a>
            <p>{thread.blurb}</p>
            <p class="meta">{thread.year} · {thread.type}</p>
          </li>
        ))}
      </ul>
    </section>

    <section id="experience" class="mobile-story-section">
      <h2>Experience</h2>
      <p>Built cross-disciplinary work streams in music production, visual storytelling, and civic collaboration across Newark communities.</p>
      <p>Current focus: documenting process in public, shipping creative studies, and evolving this archive into a living portfolio timeline.</p>
    </section>

    <section id="skills" class="mobile-story-section">
      <h2>Skills / Tools</h2>
      <div class="mobile-pill-grid">
        {tools.map((tool) => <span>{tool}</span>)}
      </div>
    </section>

    <section id="media" class="mobile-story-section">
      <h2>Media</h2>
      <ul class="mobile-post-list">
        {posts.map((post) => (
          <li>
            <a href={`/writing/${post.slug}`}>{post.data.title}</a>
            <p>{post.data.summary}</p>
          </li>
        ))}
      </ul>
    </section>

    <section id="resume" class="mobile-story-section">
      <h2>Resume / CV</h2>
      <p>For speaking, collaborations, and portfolio details, use the press kit and updated project index.</p>
      <p><a href="/press-kit">Open press kit</a></p>
    </section>

    <section id="contact" class="mobile-story-section">
      <h2>Contact</h2>
      <p>Use the form for inquiries, collaborations, and project commissions.</p>
      <p><a href="/contact">Open contact form</a></p>
    </section>

    <section id="links" class="mobile-story-section">
      <h2>Links</h2>
      <ul class="mobile-link-list">
        <li><a href={profile.social_links.instagram}>Instagram</a></li>
        <li><a href={profile.social_links.youtube}>YouTube</a></li>
        <li><a href={profile.social_links.discord}>Discord</a></li>
        <li><a href={profile.link_hub_url}>Link hub</a></li>
      </ul>
    </section>
  </article>

  <script is:inline>
    (() => {
      const tabs = Array.from(document.querySelectorAll('[data-section-tab]'));
      const panels = Array.from(document.querySelectorAll('[data-section-panel]'));
      if (!tabs.length || !panels.length) return;

      const activate = (id) => {
        tabs.forEach((tab) => {
          const active = tab.getAttribute('data-section-tab') === id;
          tab.classList.toggle('is-active', active);
          tab.setAttribute('aria-selected', String(active));
        });
        panels.forEach((panel) => {
          const active = panel.getAttribute('data-section-panel') === id;
          panel.classList.toggle('is-active', active);
        });
      };

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const id = tab.getAttribute('data-section-tab');
          if (id) activate(id);
        });
      });

      const first = tabs[0]?.getAttribute('data-section-tab');
      if (first) activate(first);
    })();
  </script>
</BaseLayout>

<style>
  .section-tab {
    border: 1px solid var(--line2);
    background: rgba(8, 12, 20, 0.42);
    color: var(--tone-text);
    cursor: pointer;
    transition: border-color 140ms ease, color 140ms ease, background-color 140ms ease;
  }

  .section-tab:hover,
  .section-tab:focus-visible,
  .section-tab.is-active {
    border-color: color-mix(in srgb, var(--tone-accent) 24%, var(--line2));
    color: var(--tone-accent-glow);
    background: rgba(8, 12, 20, 0.58);
  }

  .section-panel {
    display: none;
  }

  .section-panel.is-active {
    display: block;
  }
</style>
